# 简介

RISCV指令集架构，是一个模块化设计的指令集架构，具有可裁剪可扩展的特性。RISCV指令集被分为：基础指令集、标准扩展、非标准扩展

基础指令集：实现了现代编译器级操作系统相关的指令

标准扩展：主要用于加速乘除法、浮点运算、SIMD、向量运算、原子操作等

非标准扩展：这一部分是客户定制的，根据具体芯片需求添加的功能

在2.2版本的RISCV指令集架构手册中，当前指令集的版本情况如下。

| 基础指令集  | 版本   | 已冻结  |
| ------ | ---- | ---- |
| RV32I  | 2.0  | Y    |
| RV32E  | 1.9  | N    |
| RV64I  | 2.0  | Y    |
| RV128I | 1.7  | N    |



| 扩展指令集 | 版本   | 已冻结  |
| ----- | ---- | ---- |
| M     | 2.0  | Y    |
| A     | 2.0  | Y    |
| F     | 2.0  | Y    |
| D     | 2.0  | Y    |
| Q     | 2.0  | Y    |
| L     | 0.0  | N    |
| C     | 2.0  | Y    |
| B     | 0.0  | N    |
| J     | 0.0  | N    |
| T     | 0.0  | N    |
| P     | 0.1  | N    |
| V     | 0.2  | N    |
| N     | 1.1  | N    |

指令集及意义

| 名称     | 意义              |
| ------ | --------------- |
| RV32I  | 32位机的基础指令集      |
| RV32E  | 适用与嵌入式系统的32位指令集 |
| RV64I  | 64位机的基础指令集      |
| RV128I | 128位机的基础指令集     |
| M      | 整数乘除法           |
| A      | 原子操作            |
| F      | 32比特浮点运算        |
| D      | 64比特浮点运算        |
| Q      | 128比特浮点运算       |
| L      | 十进制浮点运算         |
| C      | 压缩指令集           |
| B      | 比特位操作           |
| J      | 动态语言相关扩展        |
| T      | 事务操作            |
| P      | SIMD            |
| V      | 向量操作            |
| N      | 用户级中断扩展         |

# 寄存器

在RV32I/RV64I/RV128下可以访问32个寄存器，X0-X31。在RV32I下为64比特宽度，在RV64I下为64比特宽度，在RV128下为128比特宽度。

其在X0为**ZERO-Register**，硬链接到0，读取此寄存器的值为0，任何下入此寄存器的值被丢弃

PC寄存器不可用直接访问，只能通过分支指令间接操作PC

# 浮点寄存器

硬件浮点数操作使用独立的寄存器f0-f31，并具有独立的状态寄存器fcsr。

# 特权等级

RISC-V具有3个特权等级

| 等级   | 编码   | 名字               | 简写   |
| ---- | ---- | ---------------- | ---- |
| 0    | 00   | User/Application | U    |
| 1    | 01   | Supervisor       | S    |
| 2    | 10   | Reserved         |      |
| 3    | 11   | Machine          | M    |

只有M特权是必须实现的，其他特权等级都是可选实现的，以下是特权等级实现与应用场景

| 特权等级个数 | 支持的特权等级 | 应用场景             |
| ------ | ------- | ---------------- |
| 1      | M       | 简单的嵌入式系统         |
| 2      | M，U     | 安全的嵌入式系统         |
| 3      | M，S，U   | 可以运行类似Unix OS的系统 |

# CSR(Control and Status Registers)

CSR(Control and Status Registers)编码进12比特的地址空间。

编码规则

* CSR[11:10] 用于标记寄存器的读写权限（00/01/10可读写，11只读）
* CSR[9:8]      用于标记可以访问此寄存器的最低特权等级

## 机器信息相关寄存器

以下寄存器必须实现

**misa** 处理器字长信息和指令信息（包含的基础指令和扩展信息）

**mvendorid** 厂商ID，非商业实现为0

**mimpid** 机器架构实现版本（不包含外设信息，之和内核实现相关），非商业实现为0

**mhartid** 处理器核心ID，必须有一个处理器的核心id为0

## 状态寄存器

状态寄存器用于控制和监控处理器状态

**mstatus**为M特权等级下的状态寄存器

**sstatus** 为S特权等级下的状态寄存器

**ustatus** 为U特权等级下的状态寄存器

### 中断使能

**MIE/SIE/UIE**分别用于使能各特权等级下的异常和中断

### 中断保护

**MPIE/SPIE/UPIE**用于保护进入异常前的中断使能位状态

**MPP/SPP**用于保护进入异常之前的特权等级。没有UPP，因为进入U特权等级的异常只能返回到U特权等级

### 字长控制

**SXL/UXL**用于控制低特权等级的字长

### 虚拟内存相关

**MPRV**用于使能地址转换和权限保护

**MXR**使只有执行权限的内存可以加载

**SUM**使S特权等级可以访问U特权等级的内存

### 虚拟化相关

**TVM**（Trap Virtual Memory）等于1时，访问**satp**寄存器或者执行**SFENCE.VMA**将促发非法指令异常

**TW**（Timeout Wait）等于1时，执行**WFI**指令等待特定一段时间（一般为0）后将促发非法指令异常

**TSR**（Trap SRET）等于1时，在S特权等级执行**SRET**将促发非法指令异常

### 现场保护恢复加速

**FS/XS/SD**用于记录加速现场保护恢复


## 向量基地址

向量基地址用于控制发生异常时的跳转地址，向量基地址必须4个字节对齐，这样低两位空闲未用。这时低两位用于设定向量地址模式

**mtvec** 路由到M特权等级的异常基地址

**stvec** 路由到S特权等级的异常基地址

**utvec** 路由到U特权等级的异常基地址

向量模式，用于控制异常发生时的跳转地址

| 值    | 名字   | 描述                             |
| ---- | ---- | ------------------------------ |
| 0    | 直接   | 所有异常跳转到BASE（BASE为mtvec指定的地址）   |
| 1    | 向量   | 异步中断跳转到BASE+4*case（case为异常向量号） |
| >1   | —    | 保留                             |

## 异常委托

**medeleg**在M特权等级下的异常委托寄存器，被标记的异常将委托给S特权等级处理

**sedeleg**在S特权等级下的异常委托寄存器，被标记的异常将委托给U特权等级处理

**mideleg**在M特权等级下的中断委托寄存器，被标记的中断将委托给S特权等级处理

**sideleg**在S特权等级下的中断委托寄存器，被标记的中断将委托给U特权等级处理

## 中断控制寄存器

**mip/sip**待处理异常寄存器，用于标记那些异常需要处理

**mie/sie**用于使能异常（低异常等级软件中断、时钟中断、外部中断）

## 定时器

**mtime**时钟计数器

**mtimecmp**时钟比较器，当**mtime > mtimecmp**时将促发中断（需要中断使能）

## 计数器

**mcycle**对内核执行周期计数

**minstret**用于对内核阻塞周期计数

**mhpmcounter3-mhpmcounter31**额外的29个计算器

**mhpmevent3-mhpmevent31**额外29个计数器的事件选择器，用于选择计数对象（0标示没有计数对象）

**mcounteren/scounteren**用于使能计算器

## scratch

**mscratch/sscratch/uscratch**普通的可读写的寄存器，一般用于保存上下文，可根据客户需求使用

## 异常返回地址

**mepc/sepc/uepc**用于保存异常返回地址

## 异常源

**mcause/scause/ucause**分别记录进入M/S/U特权等级时的异常源

异常源以整数编码，最高位标记是中断

## 异常地址

**mtval/stval/utval**用于记录指令取址、储存器访问不不齐、页错误、断点时的地址信息

# 特权指令

## ECALL

系统调用指令

在M/S/U特权模式下分别产生**environment-call-from-M-mode/environment-call-from-S-mode/environment-call-from-U-mode**异常

## EBREAK

断点指令，用于产生**Breakpoint**异常，用于进入调试异常

## 异常返回指令

**MRET/SRET/URET**用于M/S/U特权模式退出异常

## 中断等待指令

**WFI**用于等待中断发生

## SFENCE.VMA

更新同步内存管理数据结构

# 复位

复位时处于M状态，MIE=0禁止中断，MPRV=0禁止内存地址转换内存保护，pc的值与具体实现相关。

mcause的值与具体实现相关，在不区分复位原因的机器上为0，在区分复位原因的机器上用0标示上电复位。

# 物理内存保护

物理内存保护简称**PMP（physical memory protection ）**，以下描述的是标准实现，具体平台实现可能和这个有差异

RV32支持34比特物理地址（16GB），RV64支持56比特物理地址（64PB）

为了支持安全处理，M特权等级支持PMP

PMP可以配置16个内存地址范围，每一个配置被称为一个PMP entries

每一个PMP entries有一个8比特的配置寄存器（pmp0cfg-pmp15cfg）和一个地址寄存器（pmpaddr0–pmpaddr15）

地址寄存器在RV32下为32比特表示物理地在的[33:2]，地在寄存器在RV64下为64比特但只有54比特有效表示物理地在的[55:2]

## 配置寄存器

配置寄存器用于指定物理内存的权限（读、写、执行），地址匹配模式以及锁定配置

配置寄存器pmp0cfg-pmp15cfg，在RV32下每4个一组映射到CSR（pmpcfg0、pmpcfg1、pmpcfg2、pmpcfg3），在RV64下每8个一组映射到（pmpcfg0、pmpcfg2）

配置寄存器位域及作用

|  名字  |  位域   | 作用      |
| :--: | :---: | ------- |
|  R   | [0:0] | 读权限     |
|  W   | [1:1] | 写权限     |
|  X   | [2:2] | 执行权限    |
|  A   | [4:3] | 地址匹配模式  |
|  L   | [7:7] | 锁定，防止篡改 |

## 地址匹配模式

地址匹配模式跟配置寄存器中A相关

| 值    | 模式名                                      | 描述              |
| ---- | ---------------------------------------- | --------------- |
| 0    | OFF                                      | 关闭              |
| 1    | TOR（Top of range）                        | 地址记录的为内存的上限地址   |
| 2    | NA4（Naturally aligned four-byte region）  | 标示4个字节的地址范围     |
| 3    | NAPOT（Naturally aligned power-of-two region,>=8 bytes） | 标示大于等于4个字节的地址范围 |

- OFF

即不使用当前的配置

- TOR

如果第i个配置寄存器配置模式配置为TOR时有两种情况：

i = 0，匹配地址 $0 < address < pmpaddr_i$

i > 0，匹配地址 $pmpaddr_{i-1} < address < pmpaddr_i$

- NA4

观察地址可以发现，地址低2比特为0。NA4即标示配置地在开始的4个字节

- NAPO

此模式比较特别，具体含有如图示意

| 配置         | 起始地址         | 长度          |
| ---------- | ------------ | ----------- |
| aaa...aaa0 | aaa...aaa000 | $2^{0 + 3}$ |
| aaa...aa01 | aaa...aa0000 | $2^{1 + 3}$ |
| aaa...a011 | aaa...a00000 | $2^{2 + 3}$ |

从表中看出，表示的其实就算一个高位有效的地址范围

## 物理内存保护锁

PMP配置寄存器中，有一个加锁位。置1加锁，加锁后不能改写配置寄存器和地址寄存器，如果配置寄存器地址匹配模式为TOR前一个地址寄存器也不可以修改。即上锁位置1后，配置将被锁定。

## 保护和匹配逻辑

一次内存访问的地址范围必须在一个PMP地址范围内。比如一个NA4的配置（0xc-0xF），访问0x8-0xF导致失败。

如果访问内存的地址不能匹配到PMP entries，在M特权等级下可以正常访问，在S、U特权等级下将访问失败。

PMP会影响所有U、S特权等级下的内存访问。如果MPRV置1，还将影响从U、S特权等级陷入M特权等级下的LOAD、STORE



# 地址转换与内存保护

地在转换和内存保护，即虚拟内存、MMU

RV32支持34比特器物理地址空间（16GB），RV64支持56比特物理地址空间（64PB）

## 地址转换保护寄存器

**satp(Superior Address Translation and protection)** 地址保护寄存器，主要用于设置虚拟地址转换模式以及根页表位置

- RV32下描述如下

| 名字   | 位域      | 描述          |
| :--- | :------ | ----------- |
| MODE | [31:31] | 地址转换与内存保护模式 |
| ASID | [30:22] | 地址空间标示符     |
| PPN  | [21:0]  | 物理页编号       |

MODE描述

| 值    | 名字   | 描述                     |
| ---- | ---- | ---------------------- |
| 0    | Base | 不使用地址转换与内存保护           |
| 1    | Sv32 | 使用32比特的虚拟地址空间进行内存转换和保护 |


- RV64下描述如下

| 名字   | 位域      | 描述          |
| :--- | ------- | ----------- |
| MODE | [63:60] | 地址转换与内存保护模式 |
| ASID | [59:44] | 地址空间标示符     |
| PPN  | [43:0]  | 物理页编号       |

MODE描述

| 值     | 名字   | 描述                       |
| ----- | ---- | ------------------------ |
| 0     | Base | 不使用地址转换与内存保护             |
| 1 - 7 | —    | 保留未用                     |
| 8     | Sv39 | 使用39比特的虚拟地址空间进行内存地址转换和保护 |
| 9     | Sv48 | 使用48比特的虚拟地址空间进行内存地址转换和保护 |
| 10    | Sv57 | 为57比特虚拟地址空间保留            |
| 11    | Sv64 | 为64比特虚拟地址空间保留            |
| 12-15 | —    | 保留未用                     |

## Sv32 32比特虚拟内存系统

Sv32是RV32下的虚拟内存系统，具有2级页表，每级页表4K字节包含1024个页表描述符

Sv32具有两种页4K/4M

虚拟地址、物理地址及页表描述符如下图
![Markdown](http://i2.muimg.com/1949/782f961fdb6d9453.png)

页表描述符
- V 标示页表描述符有效
- R 目标页可读
- W 目标页可写
- X 目标页可执行
- U 目标页为U特权等级内存
- G 全局映射
- A（accessed） 标示目标页被访问过，用于标示cache状态
- D（dirty） 标示目标页被修改过，用于标示cache状态
- RSW 保留给S特权等级使用

目标内存页如果可写必须标记为可读

如果R、W、X全部为0标示非叶子节点，当前描述符指向下一级页表

## Sv39 39比特虚拟内存系统
Sv39是RV64下的虚拟内存系统，具有2级页表，每级页表2K字节包含512个页表描述符

Sv39具有4K/2M/1G的页

虚拟地址、物理地址及页表描述符如下图

![Markdown](http://i1.buimg.com/1949/21a1ba54b0d5d786.png)

页表描述符
- V 标示页表描述符有效
- R 目标页可读
- W 目标页可写
- X 目标页可执行
- U 目标页为U特权等级内存
- G 全局映射
- A（accessed） 标示目标页被访问过，用于标示cache状态
- D（dirty） 标示目标页被修改过，用于标示cache状态
- RSW 保留给S特权等级使用

目标内存页如果可写必须标记为可读

如果R、W、X全部为0标示非叶子节点，当前描述符指向下一级页表



## Sv48 48比特虚拟内存系统
Sv48是RV64下的虚拟内存系统，具有2级页表，每级页表2K字节包含512个页表描述符

Sv48具有页4K/2M/1G/512G的页

虚拟地址、物理地址及页表描述符如下图

![Markdown](http://i1.buimg.com/1949/f5db47b6d77e7ce4.png)

页表描述符
- V 标示页表描述符有效
- R 目标页可读
- W 目标页可写
- X 目标页可执行
- U 目标页为U特权等级内存
- G 全局映射
- A（accessed） 标示目标页被访问过，用于标示cache状态
- D（dirty） 标示目标页被修改过，用于标示cache状态
- RSW 保留给S特权等级使用

目标内存页如果可写必须标记为可读

如果R、W、X全部为0标示非叶子节点，当前描述符指向下一级页表